<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackwood coffee - Panel de Control</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="controlcaja.css"> 
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Estilos para las p√≠ldoras de estado en la tabla */
        .status-pill {
            padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; color: #fff; text-align: center; display: inline-block;
        }
        /* Estas clases DEBEN coincidir con los estados que vienen de tu BD (sin espacios) */
        .status-Proceso { background-color: #ffc107; color: #332a23; } /* Amarillo */
        .status-Finalizado { background-color: #28a745; } /* Verde (Usado para 'Finalizado' en tu BD) */
        .status-Pendiente { background-color: #007bff; } /* Azul (Usado para 'Pendiente' en tu BD) */
        .status-Cancelado { background-color: #dc3545; } /* Rojo */
        .status-Completado { background-color: #28a745; } /* Verde (Alternativa si usas 'Completado') */


        /* Estilos para el Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 25px; width: 90%; max-width: 450px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content h2 { text-align: center; margin-top: 0; color: var(--text-dark); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: "Poppins", sans-serif; box-sizing: border-box; }
        .submit-button { background-color: var(--accent); color: var(--white); padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .submit-button:hover { background-color: #a56d35; }
    </style>
</head>
<body>

<div class="container">
    <div id="navbar-placeholder"></div>

    <main class="main">
        <div class="main-scroll">
            <header class="header">
                <h1 class="header-title">Blackwood Coffee</h1>
                <h2 class="panel-title">Panel de control</h2>
                <div class="date"></div>
            </header>
            <div class="dashboard">
                <div class="card"><div class="card-header">Ventas Turno üí≤</div><div class="card-value" id="dash-ventas">$0.00</div></div>
                <div class="card"><div class="card-header">Pedidos Turno ‚ÜóÔ∏è</div><div class="card-value" id="dash-pedidos">0</div></div>
                
                <div id="btnAbrirCorte" class="card card-action">
                    <div class="card-header">Corte de Caja</div>
                    <div class="card-value">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                    </div>
                </div>
            </div>
            <div class="panel-bottom">
                <div class="panel-table">
                    <div class="panel-table-header">√öltimos pedidos</div> 
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Id</th><th>Estatus</th><th>Pago</th><th>Hora</th></tr></thead>
                            <tbody id="tabla-pedidos-body">
                                <tr><td colspan="4" style="text-align:center;">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="panel-alerts">
                    <div class="panel-alerts-header">Alertas de inventario üìã</div>
                    <ul id="lista-alertas">
                        <li>Cargando alertas...</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="corteModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Realizar Corte de Caja</h2>
        <form id="corteForm">
            <div class="input-group">
                <label for="fondoInicial">Fondo inicial (FI)</label>
                <input type="number" step="0.01" id="fondoInicial" placeholder="$0.00" required>
            </div>
            <div class="input-group">
                <label for="ventasEfectivo">Ventas en efectivo (VE)</label>
                <input type="number" step="0.01" id="ventasEfectivo" placeholder="$0.00" required>
            </div>
            <div class="input-group">
                <label for="ventasTarjeta">Ventas con tarjeta (VT)</label>
                <input type="number" step="0.01" id="ventasTarjeta" placeholder="$0.00" required>
            </div>
            <div class="input-group">
                <label for="gastosRetiros">Gastos / Retiros (RG)</label>
                <input type="number" step="0.01" id="gastosRetiros" placeholder="$0.00" required>
            </div>
            <div class="input-group">
                <label for="conteoReal">Conteo real de efectivo (En Caja)</label>
                <input type="number" step="0.01" id="conteoReal" placeholder="$0.00" required>
            </div>
            <button type="submit" class="submit-button">Realizar Corte y Cerrar Turno</button>
        </form>
    </div>
</div>


<script src="../barraNav.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const currentPage = window.location.pathname.split("/").pop();
        if(typeof cargarBarraNav === 'function') cargarBarraNav(currentPage);
        
        // Cargar datos al iniciar y configurar un intervalo de actualizaci√≥n (opcional)
        cargarDatosDashboard(); 
        setInterval(cargarDatosDashboard, 10000); // Actualiza cada 10 segundos
    });

    function cargarDatosDashboard() {
        fetch('get_datos_dashboard.php')
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                // 1. Actualizar tarjetas superiores
                document.getElementById('dash-ventas').textContent = '$' + parseFloat(data.ventas_hoy).toFixed(2);
                document.getElementById('dash-pedidos').textContent = data.conteo_pedidos;

                // 2. Actualizar tabla de pedidos
                const tbody = document.getElementById('tabla-pedidos-body');
                tbody.innerHTML = '';
                if (data.pedidos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Sin pedidos en este turno</td></tr>';
                } else {
                    data.pedidos.forEach(p => {
                        // **CORRECCI√ìN CLAVE:** Eliminamos cualquier car√°cter no alfanum√©rico para crear la clase CSS
                        // Si el estado es "En Proceso", se convierte en "status-EnProceso"
                        // Si el estado es "Finalizado", se convierte en "status-Finalizado"
                        const estadoClase = 'status-' + p.estado.replace(/[^a-zA-Z0-9]/g, ''); 
                        
                        let row = `<tr>
                            <td>#${p.id_pedido}</td>
                            <td><span class="status-pill ${estadoClase}">${p.estado}</span></td>
                            <td>${p.metodo_pago}</td>
                            <td>${p.hora}</td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                }

                // 3. Actualizar alertas de inventario
                const ul = document.getElementById('lista-alertas');
                ul.innerHTML = '';
                if (data.alertas.length === 0) {
                    ul.innerHTML = '<li style="color:green; list-style-type: none;">Inventario saludable ‚úÖ</li>';
                } else {
                    data.alertas.forEach(prod => {
                        ul.innerHTML += `<li>${prod.namep} quedan <strong>${prod.STOCK}</strong></li>`;
                    });
                }
            } else {
                console.error("Error API:", data.error);
                document.getElementById('tabla-pedidos-body').innerHTML = '<tr><td colspan="4" style="text-align:center; color: red;">Error al cargar pedidos.</td></tr>';
                document.getElementById('lista-alertas').innerHTML = '<li style="color: red;">Error al cargar alertas.</li>';
            }
        })
        .catch(err => {
            console.error("Error fetch:", err);
            document.getElementById('tabla-pedidos-body').innerHTML = '<tr><td colspan="4" style="text-align:center; color: red;">Error de conexi√≥n.</td></tr>';
            document.getElementById('lista-alertas').innerHTML = '<li style="color: red;">Error de conexi√≥n.</li>';
        });
    }

    // --- L√ìGICA DE FECHA Y MODAL ---
    const dateElement = document.querySelector('.date');
    if (dateElement) {
        const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
        const fechaActual = new Date();
        dateElement.textContent = `${dias[fechaActual.getDay()]}, ${fechaActual.getDate()} de ${meses[fechaActual.getMonth()]} de ${fechaActual.getFullYear()}`;
    }

    const modal = document.getElementById("corteModal");
    const btnAbrir = document.getElementById("btnAbrirCorte");
    const spanCerrar = document.querySelector(".close-button");
    const formCorte = document.getElementById("corteForm");

    btnAbrir.onclick = () => modal.style.display = "block";
    spanCerrar.onclick = () => modal.style.display = "none";
    window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; }

    // --- ENVIAR CORTE AL BACKEND ---
    formCorte.addEventListener("submit", function(event) {
        event.preventDefault();

        const datosCorte = {
            fondoInicial: parseFloat(document.getElementById("fondoInicial").value) || 0,
            ventasEfectivo: parseFloat(document.getElementById("ventasEfectivo").value) || 0,
            ventasTarjeta: parseFloat(document.getElementById("ventasTarjeta").value) || 0,
            gastosRetiros: parseFloat(document.getElementById("gastosRetiros").value) || 0,
            conteoReal: parseFloat(document.getElementById("conteoReal").value) || 0
        };

        fetch('realizar_corte.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datosCorte)
        })
        .then(res => res.json())
        .then(data => {
            modal.style.display = "none";
            if (data.success) {
                let titulo = 'Corte Realizado';
                let icono = 'success';
                let mensaje;

                if (data.diferencia === 0) {
                    mensaje = "¬°Corte Exacto! Todo cuadra perfectamente.";
                } else if (data.diferencia > 0) {
                    mensaje = `Sobrante de $${data.diferencia.toFixed(2)} pesos.`;
                    icono = "info";
                } else {
                    mensaje = `Faltante de $${Math.abs(data.diferencia).toFixed(2)} pesos.`;
                    icono = "warning";
                }

                Swal.fire({
                    title: titulo,
                    text: mensaje,
                    icon: icono,
                    confirmButtonColor: '#c68644'
                }).then(() => {
                    cargarDatosDashboard();
                    formCorte.reset();
                });
            } else {
                Swal.fire('Error', 'No se pudo guardar el corte: ' + data.error, 'error');
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('Error', 'Error de conexi√≥n con el servidor', 'error');
        });
    });
</script>

</body>
</html>