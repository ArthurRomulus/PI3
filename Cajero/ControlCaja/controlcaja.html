<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackwood coffee - Panel de Control</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="controlcaja.css"> 
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 25px; width: 90%; max-width: 450px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content h2 { text-align: center; margin-top: 0; color: var(--text-dark); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: "Poppins", sans-serif; box-sizing: border-box; }
        .submit-button { background-color: var(--accent); color: var(--white); padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .submit-button:hover { background-color: #a56d35; }
    </style>
</head>
<body>

<div class="container">
    <div id="navbar-placeholder"></div>

    <main class="main">
        <div class="main-scroll">
            <header class="header">
                <h1 class="header-title">Blackwood Coffee</h1>
                <h2 class="panel-title" data-translate="Panel de control">Panel de control</h2>
                <div class="date"></div>
            </header>
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <span data-translate="Ventas del Turno">Ventas del Turno</span> üí≤
                    </div>
                    <div class="card-value" id="dash-ventas">$0.00</div>
                    </div>

                <div class="card">
                <div class="card-header">
                    <span data-translate="Pedidos Turno">Pedidos Turno</span> ‚ÜóÔ∏è
                </div>
                <div class="card-value" id="dash-pedidos">0</div>
                </div>

                
                <div id="btnAbrirCorte" class="card card-action">
                    <div class="card-header" data-translate="Control de Caja">Control de Caja</div>
                    <div class="card-value">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                    </div>
                </div>
            </div>
            <div class="panel-bottom">
                <div class="panel-table">
                    <div class="panel-table-header" data-translate="√öltimos pedidos">√öltimos pedidos</div> 
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Id</th><th data-translate="Estatus">Estatus</th><th data-translate="Pago">Pago</th><th data-translate="Hora">Hora</th></tr></thead>
                            <tbody id="tabla-pedidos-body">
                                <tr><td colspan="4" style="text-align:center;">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="panel-alerts">
                    <div class="panel-alerts-header">
                        <span data-translate="Alertas de inventario">Alertas de inventario</span> üìã
                    </div>
                    <ul id="lista-alertas">
                        <li>Cargando alertas...</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="corteModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 data-translate="Realizar Control de Caja">Realizar Control de Caja</h2>
        <form id="corteForm">
            <div class="input-group">
                <label for="fondoInicial" data-translate="Fondo inicial (FI)">Fondo inicial (FI)</label>
                <input type="number" step="0.01" id="fondoInicial" placeholder="$0.00" required>
            </div>
            <div class="input-group">
                <label for="ventasEfectivo" data-translate="Ventas en efectivo (VE)">Ventas en efectivo (VE)</label>
                <input type="number" step="0.01" id="ventasEfectivo" placeholder="$0.00" required>
            </div>
            <div class="input-group">
                <label for="ventasTarjeta" data-translate="Ventas con tarjeta (VT)">Ventas con tarjeta (VT)</label>
                <input type="number" step="0.01" id="ventasTarjeta" placeholder="$0.00" required>
            </div>
            <div class="input-group">
                <label for="gastosRetiros" data-translate="Gastos / Retiros (RG)">Gastos / Retiros (RG)</label>
                <input type="number" step="0.01" id="gastosRetiros" placeholder="$0.00" required>
            </div>
            <div class="input-group">
                <label for="conteoReal" data-translate="Conteo real de efectivo">Conteo real de efectivo (En Caja)</label>
                <input type="number" step="0.01" id="conteoReal" placeholder="$0.00" required>
            </div>
            <button type="submit" class="submit-button" data-translate="Realizar Control de caja y Cerrar Turno">Realizar Control de caja y Cerrar Turno</button>
        </form>
    </div>
</div>

<script src="../barraNav.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const currentPage = window.location.pathname.split("/").pop();
        if(typeof cargarBarraNav === 'function') cargarBarraNav(currentPage);
        
        // Cargar datos y configurar intervalo
        cargarDatosDashboard(); 
        setInterval(cargarDatosDashboard, 10000); 

        // Configurar fecha
        const dateElement = document.querySelector('.date');
        if (dateElement) {
            const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            const f = new Date();
            dateElement.textContent = `${dias[f.getDay()]}, ${f.getDate()} de ${meses[f.getMonth()]} de ${f.getFullYear()}`;
        }

        // --- L√ìGICA DEL MODAL DE CORTE ---
        const modal = document.getElementById("corteModal");
        const btnAbrir = document.getElementById("btnAbrirCorte");
        const spanCerrar = document.querySelector(".close-button");

        btnAbrir.onclick = () => modal.style.display = "block";
        spanCerrar.onclick = () => modal.style.display = "none";
        window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; }
    });

    // --- 1. FUNCI√ìN DE CARGA DE DATOS ---
    function cargarDatosDashboard() {
        fetch('get_datos_dashboard.php')
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                document.getElementById('dash-ventas').textContent = '$' + parseFloat(data.ventas_hoy).toFixed(2);
                document.getElementById('dash-pedidos').textContent = data.conteo_pedidos;

                const tbody = document.getElementById('tabla-pedidos-body');
                tbody.innerHTML = '';
                
                if (data.pedidos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Sin pedidos en este turno</td></tr>';
                } else {
                    data.pedidos.forEach(p => {
                        // Limpiamos estado (fallback a "En espera" si viene vac√≠o)
                        let estadoReal = p.estado ? p.estado.trim() : '';
                        if(estadoReal === '') estadoReal = 'En espera'; 

                        const minutos = p.minutos ? parseInt(p.minutos) : 0; 
                        const claseColor = obtenerClaseColor(estadoReal);

                        // L√≥gica de Alerta: Solo "En espera" + tiempo
                        let claseAnimacion = "";
                        let iconoAlerta = "";
                        if (estadoReal.toLowerCase().includes('espera') && minutos > 15) {
                            claseAnimacion = "animacion-alerta"; 
                            iconoAlerta = `<span class="icono-retraso" title="Cliente esperando hace ${minutos} mins">‚ö†Ô∏è‚è≥</span>`;
                        }

                        // Select
                        const selectHTML = `
                            <select class="select-estado ${claseColor} ${claseAnimacion}" 
                                    onchange="cambiarEstado(${p.id_pedido}, this)">
                                 <option value="En espera" 
                                    ${estadoReal === 'En espera' ? 'selected' : ''} 
                                    data-translate="En espera">En espera</option>

                                <option value="En preparaci√≥n" 
                                    ${estadoReal === 'En preparaci√≥n' ? 'selected' : ''} 
                                    data-translate="En preparaci√≥n">En preparaci√≥n</option>

                                <option value="Completado" 
                                    ${estadoReal === 'Completado' ? 'selected' : ''} 
                                    data-translate="Completado">Completado</option>

                            </select>
                            ${iconoAlerta}
                        `;
                        applyTranslation(localStorage.getItem("lang"));


                        let row = `<tr>
                            <td>#${p.id_pedido}</td>
                            <td style="display:flex; align-items:center; gap:5px;">${selectHTML}</td>
                            <td data-translate="${p.metodo_pago}">${p.metodo_pago}</td>
                            <td>${p.hora}</td>
                        </tr>`;
                        tbody.innerHTML += row;
                        applyTranslation(localStorage.getItem("lang"));
                    });
                }

                const ul = document.getElementById('lista-alertas');
                ul.innerHTML = '';
                if (data.alertas.length === 0) {
                    ul.innerHTML = '<li style="color:green; list-style-type: none;">Inventario saludable ‚úÖ</li>';
                } else {
                    data.alertas.forEach(prod => {
                        ul.innerHTML += `<li>
                            <span data-translate="${prod.namep}">${prod.namep}</span>
                            <span data-translate="quedan">quedan</span>
                            <strong>${prod.STOCK}</strong>
                        </li>`;
                    // RE-APLICAR TRADUCCI√ìN
                    applyTranslation(localStorage.getItem("lang"));;
                    });
                }
            } else {
                console.error("Error API:", data.error);
            }
        })
        .catch(err => console.error("Error fetch:", err));
    }

    // --- 2. FUNCIONES AUXILIARES DE COLOR ---
    function obtenerClaseColor(status) {
        if (!status) return '';
        const s = status.toLowerCase();
        if (s.includes('espera')) return 'estilo-rojo';
        if (s.includes('prepara')) return 'estilo-azul';
        if (s.includes('completa')) return 'estilo-verde';
        return '';
    }

    // --- 3. ACTUALIZAR ESTADO (BACKEND) ---
    function cambiarEstado(idPedido, selectElement) {
        const nuevoEstado = selectElement.value;
        const nuevaClase = obtenerClaseColor(nuevoEstado);
        selectElement.className = `select-estado ${nuevaClase}`;

        fetch('update_estado.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_pedido: idPedido, nuevo_estado: nuevoEstado })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true
                });
                Toast.fire({ icon: 'success', title: 'Actualizado' });
            } else {
                Swal.fire('Error', 'No se guard√≥: ' + data.error, 'error');
                cargarDatosDashboard(); 
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('Error', 'Error de conexi√≥n', 'error');
        });
    }

    // --- 4. L√ìGICA RESTAURADA DEL BOT√ìN DE CORTE ---
    const formCorte = document.getElementById("corteForm");
    formCorte.addEventListener("submit", function(event) {
        event.preventDefault();

        const datosCorte = {
            fondoInicial: parseFloat(document.getElementById("fondoInicial").value) || 0,
            ventasEfectivo: parseFloat(document.getElementById("ventasEfectivo").value) || 0,
            ventasTarjeta: parseFloat(document.getElementById("ventasTarjeta").value) || 0,
            gastosRetiros: parseFloat(document.getElementById("gastosRetiros").value) || 0,
            conteoReal: parseFloat(document.getElementById("conteoReal").value) || 0
        };

        const modal = document.getElementById("corteModal");

        fetch('realizar_corte.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datosCorte)
        })
        .then(res => res.json())
        .then(data => {
            modal.style.display = "none";
            if (data.success) {
                let titulo = currentLang === "es" ? "Corte Realizado" : "Cut Completed";
                let icono = 'success';
                let mensaje;

                if (data.diferencia === 0) {
                    mensaje = currentLang === "es"
                        ? "¬°Corte Exacto! Todo cuadra perfectamente."
                        : "Perfect Count! Everything matches evenly.";
                } else if (data.diferencia > 0) {
                    mensaje = currentLang === "es"
                        ? `Sobrante de $${data.diferencia.toFixed(2)} pesos.`
                        : `Surplus of $${data.diferencia.toFixed(2)} pesos.`;
                    icono = "info";
                } else {
                    mensaje = currentLang === "es"
                        ? `Faltante de $${Math.abs(data.diferencia).toFixed(2)} pesos.`
                        : `Shortage of $${Math.abs(data.diferencia).toFixed(2)} pesos.`;
                    icono = "warning";
                }

                Swal.fire({
                    title: titulo,
                    text: mensaje,
                    icon: icono,
                    confirmButtonColor: '#c68644'
                }).then(() => {
                    cargarDatosDashboard();
                    formCorte.reset();
                });
            } else {
                Swal.fire('Error', 'No se pudo guardar el corte: ' + data.error, 'error');
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('Error', 'Error de conexi√≥n con el servidor', 'error');
        });
    });
</script>
<script src="../../translate.js"></script>
</body>
</html>