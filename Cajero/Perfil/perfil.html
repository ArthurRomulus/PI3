<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil y Datos Personales</title>
    <link rel="stylesheet" href="perfil.css">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div class="app-container">
        <div id="navbar-placeholder"></div>
        <main class="main-content">

<button class="btn btn-logout" id="logout-btn">Cerrar Sesión</button>

            <div class="perfil-container">

                <div class="profile-section">
                    <div class="profile-picture-container">
                        <input type="file" id="profile-upload" accept="image/*" style="display: none;">
                        <svg id="coffee-profile-svg" viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <clipPath id="profile-clip"><circle cx="100" cy="140" r="50" /></clipPath>
                            </defs>
                            <path d="M 45 235 H 155 L 170 60 H 30 Z" fill="#000000" opacity="0.1" transform="translate(5, 5)"/>
                            <path d="M 50 230 H 150 L 165 55 H 35 Z" fill="#C8A67B"/>
                            <path d="M 25 55 H 175 L 170 40 H 30 Z" fill="#6F4E37"/>
                            <path d="M 35 40 H 165 C 165 20, 35 20, 35 40 Z" fill="#6F4E37"/>
                            <path d="M 40 180 H 160 L 162 100 H 38 Z" fill="#282828"/>
                            <text x="100" y="80" text-anchor="middle" font-family="Poppins, sans-serif" font-size="12" fill="#FFFFFF" class="profile-text">Imagen de perfil</text>
                            <circle cx="100" cy="140" r="55" fill="#FFFFFF"/>
                            <image id="profile-image" clip-path="url(#profile-clip)" height="100" width="100" x="50" y="90" href="" preserveAspectRatio="xMidYMid slice"/>
                            <circle id="icon-placeholder" cx="100" cy="140" r="50" fill="#E0E0E0"/>
                            <g id="camera-icon" fill="none" stroke="#555555" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M 115 155 H 85 C 80 155, 78 152, 78 148 V 138 C 78 132, 80 130, 85 130 H 115 C 120 130, 122 132, 122 138 V 148 C 122 152, 120 155, 115 155 Z" />
                                <circle cx="100" cy="142" r="6" />
                                <line x1="110" y1="135" x2="112" y2="135" />
                            </g>
                        </svg>
                    </div>
                    <button class="btn btn-save" id="save-profile-btn">Guardar Cambios</button>
                </div>

                <div class="data-section">
                    <div class="clipboard-container">
                         <svg width="100%" height="100%" viewBox="0 0 450 600" preserveAspectRatio="xMidYMid meet">
                             <defs>
                                  <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                      <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                                      <feOffset dx="2" dy="4" result="offsetblur"/>
                                      <feMerge>
                                          <feMergeNode/>
                                          <feMergeNode in="SourceGraphic"/>
                                      </feMerge>
                                  </filter>
                                  <linearGradient id="wood-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                      <stop offset="0%" style="stop-color:#D2B48C;stop-opacity:1" />
                                      <stop offset="100%" style="stop-color:#BC986C;stop-opacity:1" />
                                  </linearGradient>
                                  <linearGradient id="clip-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                      <stop offset="0%" style="stop-color:#E0E0E0;stop-opacity:1" />
                                      <stop offset="100%" style="stop-color:#A0A0A0;stop-opacity:1" />
                                  </linearGradient>
                              </defs>
                              <rect x="25" y="50" width="400" height="525" rx="10" fill="url(#wood-gradient)" filter="url(#shadow)"/>
                              <rect x="50" y="80" width="350" height="470" rx="5" fill="#282828"/>
                              <path d="M 180 65 C 180 45, 270 45, 270 65 L 270 80 L 180 80 Z" fill="url(#clip-gradient)" stroke="#555" stroke-width="1.5"/>
                              <rect x="200" y="25" width="50" height="20" rx="10" fill="#888"/>
                              <path d="M 215 45 L 215 60 M 235 45 L 235 60" stroke="#777" stroke-width="3"/>
                         </svg>
                         <div class="form-overlay">
    <h2 class="title">DATOS PERSONALES</h2>
    <form id="datosPersonalesForm">
        <div class="form-group">
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" name="nombre_completo">
        </div>
        <div class="form-group">
            <label for="correo">Correo Electronico:</label>
            <input type="email" id="correo" name="email">
        </div>
        <div class="form-group">
            <label for="telefono">Telefono:</label>
            <input type="tel" id="telefono" name="telefono">
        </div>
        <div class="form-group">
            <label for="emergencias">Telefono emergencias:</label>
            <input type="tel" id="emergencias" name="telefono_emergencia">
        </div>
        <div class="form-group">
            <label for="direccion">Dirección vive:</label>
            <input type="text" id="direccion" name="direccion">
        </div>
        <div class="form-group">
            <label for="empleado">Numero empleado:</label>
            <input type="text" id="empleado" name="numero_empleado" readonly>
        </div>
    </form>
</div>
                    </div>
                    <button class="btn btn-save" id="save-data-btn">Guardar Cambios</button>
                </div>
            </div>
        </main>
    </div>

    <script src="../barraNav.js"></script>
<script>
    // Función para mostrar mensajes de estado con detalle de depuración
    function showStatusMessage(message, isSuccess) {
        // Usa alert para una depuración rápida
        alert(`Estado: ${isSuccess ? 'Éxito' : 'Fallo'}\nMensaje: ${message}`);
    }

    // Función de ayuda para serializar el formulario en FormData
    function serializeForm(form) {
        return new FormData(form);
    }


    document.addEventListener('DOMContentLoaded', () => {
        if (typeof cargarBarraNav === 'function') {
            cargarBarraNav();
        }

        // Elementos DOM
        const profilePictureContainer = document.querySelector('.profile-picture-container');
        const fileInput = document.getElementById('profile-upload');
        const profileImage = document.getElementById('profile-image');
        const iconPlaceholder = document.getElementById('icon-placeholder');
        const cameraIcon = document.getElementById('camera-icon');
        const datosPersonalesForm = document.getElementById('datosPersonalesForm');
        
        // Botones clave con los IDs corregidos
        const saveDataBtn = document.getElementById('save-data-btn'); // Guarda Datos de Texto
        const saveProfileBtn = document.getElementById('save-profile-btn'); // Guarda Imagen
        
        // --- Lógica de Previsualización de Imagen ---
        let selectedFile = null;

        profilePictureContainer.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file; // Guarda la referencia al archivo
                const reader = new FileReader();
                reader.onload = (e) => {
                    profileImage.setAttribute('href', e.target.result);
                    iconPlaceholder.style.display = 'none';
                    cameraIcon.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // =======================================================
        // LÓGICA DE CARGA DE DATOS (AJAX GET) - CON DEPURACIÓN
        // =======================================================
        const loadEmployeeData = async () => {
            try {
                const response = await fetch('get_perfil_data.php');

                if (!response.ok) {
                    // Si el código de respuesta no es 200 (ej. 403, 404, 500)
                    let errorDetail = `HTTP ${response.status}.`;
                    try {
                        const errorJson = await response.json();
                        errorDetail = errorJson.message || errorDetail;
                    } catch (e) {
                        // El servidor PHP tuvo un error fatal y no devolvió JSON
                        errorDetail = `HTTP ${response.status}. Error interno del servidor o ruta de 'conexion.php' incorrecta.`;
                    }
                    throw new Error(errorDetail);
                }

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // Rellenar el formulario
                    document.getElementById('nombre').value = data.nombre_completo || '';
                    document.getElementById('correo').value = data.email || '';
                    document.getElementById('telefono').value = data.telefono || '';
                    document.getElementById('emergencias').value = data.telefono_emergencia || '';
                    document.getElementById('direccion').value = data.direccion || '';
                    document.getElementById('empleado').value = data.numero_empleado || '';
                    
                    // Cargar imagen de perfil si existe
                    if (data.profilescreen) {
                        profileImage.setAttribute('href', data.profilescreen);
                        iconPlaceholder.style.display = 'none';
                        cameraIcon.style.display = 'none';
                    }
                } else {
                    // Si PHP devuelve success: false (ej. usuario no encontrado)
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error("Fallo al cargar los datos:", error);
                showStatusMessage(`No se pudieron cargar los datos del perfil. DETALLE: ${error.message}`, false);
            }
        };


        // =======================================================
        // LÓGICA DE GUARDADO DE FOTO (AJAX POST a update_perfil_picture.php)
        // =======================================================
        saveProfileBtn.addEventListener('click', async (event) => { // ID: save-profile-btn
            event.preventDefault();

            if (!selectedFile) {
                showStatusMessage("Por favor, selecciona una imagen primero.", false);
                return;
            }

            const formData = new FormData();
            formData.append('profile_file', selectedFile, selectedFile.name); 

            try {
                const response = await fetch('update_perfil_picture.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showStatusMessage(result.message, true);
                    // Recargar los datos para refrescar la foto si el guardado fue exitoso
                    loadEmployeeData(); 
                    fileInput.value = ''; 
                    selectedFile = null;
                } else {
                    showStatusMessage(result.message, false);
                }

            } catch (error) {
                console.error("Fallo al subir la imagen:", error);
                showStatusMessage("Error de conexión o servidor al guardar la imagen.", false);
            }
        });


        // =======================================================
        // LÓGICA DE GUARDADO DE DATOS (AJAX POST a update_perfil_data.php)
        // =======================================================
        saveDataBtn.addEventListener('click', async (event) => { // ID: save-data-btn
            event.preventDefault();

            const formData = new FormData(datosPersonalesForm); // Solo campos de texto
            
            try {
                const response = await fetch('update_perfil_data.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showStatusMessage(result.message, true);
                } else {
                    showStatusMessage(result.message, false);
                }

            } catch (error) {
                console.error("Fallo al guardar los datos:", error);
                showStatusMessage("Error de conexión o servidor al guardar los cambios.", false);
            }
        });
        

const logoutBtn = document.getElementById('logout-btn');
        
        logoutBtn.addEventListener('click', () => {
            // El usuario está en PI3/Cajero/Perfil/perfil.html
            // logout.php está en PI3/
            // Por lo tanto, la ruta relativa es: ../../logout.php
            window.location.href = '../../General/logout.php';
        });

        // =======================================================
        // PREVENCIÓN DE VUELTA AL HISTORIAL (Anti-Back Button)
        // =======================================================
        // Evita que la página actual sea cacheada. Al dar clic en "Atrás",
        // forzará la recarga de la página anterior (que será login.php tras el logout).
        window.onload = function() {
            if (window.history && window.history.pushState) {
                // Inserta un estado de historial falso
                window.history.pushState('forward', document.title, window.location.href);
                // Cuando el usuario intenta ir hacia atrás, volvemos a insertar el estado.
                window.onpopstate = function() {
                    window.history.pushState('forward', document.title, window.location.href);
                };
            }
        };

        // Iniciar la carga de datos al terminar de cargar la página
        loadEmployeeData();
    });
</script>
</body>
</html>