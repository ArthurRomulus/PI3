<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>BlackWood Coffe - Productos</title>
  <link rel="stylesheet" href="productos.css">
</head>
<body>
<div class="container">
  
  <div id="navbar-placeholder"></div>

  <main class="main">
    <div class="main-scroll">
      <header class="header">
        <h1>Blackwood Coffee</h1>
        <div class="date"> <!--aqui muestra la fecha --></div>
      </header>
      <section class="filters">
        <input class="search" type="search" placeholder="Buscar..." />
        <div class="cats">
          <button class="cat-btn active">Todos</button>
          <button class="cat-btn">Frappes</button>
          <button class="cat-btn">Tés</button>
            <button class="cat-btn">Cafés</button>
          <button class="cat-btn">Comida</button>
          <button class="cat-btn">Postres</button>
          <button class="cat-btn">Panes</button>
        </div>
      </section>
      
      <section class="products" aria-label="Productos">
        </section>
    </div>
  </main>

  <aside class="cart">
    <div class="order-pill"><div class="order-title">Número de Pedido</div><div class="order-number">901</div></div>
    <div class="cart-content"></div>
    <div class="cart-bottom">
      <div class="summary">
        <div class="row"><span>Sub Total:</span> <span class="summary-subtotal">$0.00</span></div>
        <div class="row"><span>IVA:</span> <span class="summary-iva">$0.00</span></div>
        <div class="row total"><span>Total:</span> <span class="summary-total">$0.00</span></div>
      </div>
      <button class="pay">PAGAR</button>
    </div>
  </aside>
</div>

<script src="../barraNav.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Carga de la barra de navegación
    const currentPage = window.location.pathname.split("/").pop();
    if (typeof cargarBarraNav === 'function') {
        cargarBarraNav(currentPage);
    }

    // --- ACTUALIZAR LA FECHA EN TIEMPO REAL ---
    const dateElement = document.querySelector('.date');
    if (dateElement) {
        const dias = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
        const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
        const fechaActual = new Date();
        const diaSemana = dias[fechaActual.getDay()];
        const diaMes = fechaActual.getDate();
        const mes = meses[fechaActual.getMonth()];
        const anio = fechaActual.getFullYear();
        dateElement.textContent = `${diaSemana}, ${diaMes} de ${mes} de ${anio}`;
    }

    // --- VARIABLES Y FUNCIONES DEL CARRITO ---
    const cartList = [];
    const cartContent = document.querySelector('.cart-content');
    const summarySubtotal = document.querySelector('.summary-subtotal');
    const summaryIVA = document.querySelector('.summary-iva');
    const summaryTotal = document.querySelector('.summary-total');
    const IVA_RATE = 0.16;

    // --- LÓGICA DE PRODUCTOS ---
    const contenedorProductos = document.querySelector('.products');
    const filterContainer = document.querySelector('.cats');
    const scrollContainer = document.querySelector('.main-scroll');
    let allProducts = [];

    // --- (NUEVO) FUNCIÓN PARA GENERAR LOS LISTBOX DINÁMICOS ---
    function generarModificadoresHtml(producto) {
        let html = '';
        
        if (producto.modificadores && producto.modificadores.length > 0) {
            // CASO 1: El producto SÍ tiene modificadores
            producto.modificadores.forEach(grupo => {
                html += `<div class="option-select">
                           <select class="modifier-select" data-id-grupo="${grupo.id}">
                             <option value="0" data-precio-extra="0" selected disabled>${grupo.nombre}</option>`;
                
                grupo.opciones.forEach(opcion => {
                    const precioTexto = opcion.precio > 0 ? ` (+$${parseFloat(opcion.precio).toFixed(2)})` : '';
                    html += `<option value="${opcion.id}" data-precio-extra="${opcion.precio}">
                               ${opcion.valor}${precioTexto}
                             </option>`;
                });
                
                html += `</select></div>`;
            });
            
            // Si solo tiene 1 modificador, añadimos uno falso para mantener la estética
            if (producto.modificadores.length === 1) {
                 html += `<div class="option-select">
                            <select class="modifier-select" disabled>
                              <option>Sin opciones</option>
                            </select>
                          </div>`;
            }

        } else {
            // CASO 2: El producto NO tiene modificadores (Muffin, Croissant)
            // Genera dos listbox bloqueados
            html = `<div class="option-select">
                        <select class="modifier-select" disabled>
                          <option>Sin opciones</option>
                        </select>
                      </div>
                      <div class="option-select">
                        <select class="modifier-select" disabled>
                          <option>Sin opciones</option>
                        </select>
                      </div>`;
        }
        
        return html;
    }

    // --- (ACTUALIZADO) Función para mostrar productos en la página ---
    function renderProducts(productsToRender, allData) {
        if (!contenedorProductos) return;
        contenedorProductos.innerHTML = '';
        
        productsToRender.forEach(producto => {
            const { tamanos } = allData; // Ya no necesitamos 'modificadores' globales

            let tagHtml = ''; 
            if (producto.categorias_nombres && producto.categorias_nombres.includes('Bebidas calientes')) {
                tagHtml = '<span class="card-tag tag-caliente">CALIENTE</span>';
            } else if (producto.categorias_nombres && producto.categorias_nombres.includes('Bebidas frias')) {
                tagHtml = '<span class="card-tag tag-frio">FRÍO</span>';
            }
            
            const foodCategories = ['Comida', 'Postres', 'Panes'];
            let isFoodItem = false;
            if (producto.categorias_nombres) {
                isFoodItem = producto.categorias_nombres.some(cat => foodCategories.includes(cat));
            }
            
            // --- ¡CAMBIOS AQUÍ! ---
            const modificadoresHtml = generarModificadoresHtml(producto);
            const tamanosHtml = generarTamanosHtml(tamanos, producto.tamano_defecto, isFoodItem);
            
            const tarjetaHTML = `
                <article class="product-card-new" data-id="${producto.idp}" data-base-price="${producto.precio}" data-name="${producto.namep}">
                    <div class="card-top">
                        ${tagHtml}
                        <span class="card-price">$${parseFloat(producto.precio).toFixed(2)}</span>
                    </div>
                    <div class="card-image"><img src="${producto.ruta_imagen}" alt="${producto.namep}"></div>
                    <div class="card-badge">${producto.namep}</div>
                    <div class="card-options">
                        
                        ${modificadoresHtml} 
                        
                        <div class="option-row quantity-selector">
                            <button class="quantity-btn minus">-</button><span class="quantity-value">1</span><button class="quantity-btn plus">+</button>
                        </div>
                        <div class="option-row size-selector">${tamanosHtml}</div>
                    </div>
                    <textarea class="extra-requests-input" placeholder="Peticiones extras..."></textarea>
                    <button class="add-to-cart-btn">Añadir a Carrito</button>
                </article>`;
            contenedorProductos.insertAdjacentHTML('beforeend', tarjetaHTML);
        });
    }

    // --- CARGA INICIAL DE PRODUCTOS DESDE API ---
    if (contenedorProductos) {
        fetch('api.php')
            .then(response => response.json())
            .then(data => {
                if (data.error || !data.success) { 
                    console.error('Error desde API:', data.error); 
                    if(data.trace) console.error('Trace:', data.trace);
                    return; 
                }
                
                allProducts = data.productos;
                renderProducts(allProducts, data); // Dibuja los productos

                // --- FILTROS DE CATEGORÍAS ---
                if (filterContainer) {
                    const normalizeText = (str) => {
                        if (!str) return "";
                        return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    }

                    filterContainer.addEventListener('click', (event) => {
                        const target = event.target;
                        if (!target.matches('.cat-btn')) return;

                        filterContainer.querySelector('.active').classList.remove('active');
                        target.classList.add('active');

                        const filterType = normalizeText(target.textContent);
                        let filteredProducts = [];

                        if (filterType === 'todos') {
                            filteredProducts = allProducts;
                        } else {
                            filteredProducts = allProducts.filter(p => {
                                if (!p.categorias_nombres || p.categorias_nombres.length === 0) {
                                    return false;
                                }
                                return p.categorias_nombres.some(catName => normalizeText(catName) === filterType);
                            });
                        }
                        
                        renderProducts(filteredProducts, data);
                    });
                }

                // --- CÓDIGO DE HIGHLIGHT (Sin cambios) ---
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');

                if (productId) {
                    setTimeout(() => { 
                        const targetCard = document.querySelector(`.product-card-new[data-id="${productId}"]`);

                        if (targetCard && scrollContainer) {
                            let hasAnimated = false; 
                            const doAnimate = () => {
                                if (hasAnimated) return;
                                hasAnimated = true;
                                scrollContainer.removeEventListener('scrollend', doAnimate);
                                targetCard.classList.add('product-highlight');
                                setTimeout(() => {
                                    targetCard.classList.remove('product-highlight');
                                }, 600); 
                            };
                            scrollContainer.addEventListener('scrollend', doAnimate, { once: true });
                            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            setTimeout(doAnimate, 700);
                        }
                    }, 100); 
                }
            });
    }

    // --- (ACTUALIZADO) MANEJADORES DE EVENTOS PARA LAS TARJETAS ---
    if (contenedorProductos) {
        // Evento para botones y clics dentro de la tarjeta
        contenedorProductos.addEventListener('click', (event) => {
            const target = event.target;
            const card = target.closest('.product-card-new');
            if (!card) return;

            // Cantidad (Sin cambios)
            if (target.matches('.quantity-btn')) {
                const quantitySpan = card.querySelector('.quantity-value');
                let quantity = parseInt(quantitySpan.textContent);
                if (target.matches('.plus')) quantity++;
                else if (target.matches('.minus') && quantity > 1) quantity--;
                quantitySpan.textContent = quantity;
                updateCardPrice(card);
            }

            // Tamaños (Sin cambios)
            if (target.closest('.size-btn')) {
                const sizeButton = target.closest('.size-btn');
                card.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
                sizeButton.classList.add('active');
                updateCardPrice(card);
            }

            // Añadir al Carrito (Lógica actualizada)
            if (target.matches('.add-to-cart-btn')) {
                
                let allOptionsSelected = true;
                let optionsDesc = [];
                let optionsPrice = 0;

                // Valida los listbox dinámicos
                const modifiers = card.querySelectorAll('.modifier-select:not(:disabled)');
                modifiers.forEach(select => {
                    if (select.selectedIndex === 0) {
                        allOptionsSelected = false;
                    }
                    const selectedOption = select.options[select.selectedIndex];
                    optionsDesc.push(selectedOption.text.split(' (')[0]); // Solo el nombre
                    optionsPrice += parseFloat(selectedOption.dataset.precioExtra || 0);
                });

                if (!allOptionsSelected && modifiers.length > 0) {
                    alert('Por favor, selecciona todas las opciones.');
                    return;
                }

                const activeSizeButton = card.querySelector('.size-btn.active');
                const sizeName = activeSizeButton ? activeSizeButton.querySelector('span').textContent : 'N/A';
                const sizePrice = activeSizeButton ? parseFloat(activeSizeButton.dataset.precioAumento) : 0;
                
                const basePrice = parseFloat(card.dataset.basePrice);
                const quantity = parseInt(card.querySelector('.quantity-value').textContent);
                const unitPrice = basePrice + sizePrice + optionsPrice;
                
                const requests = card.querySelector('.extra-requests-input').value.trim();
                if(requests) {
                    optionsDesc.push(`(${requests})`);
                }

                const productData = {
                    name: card.dataset.name,
                    price: unitPrice,
                    qty: quantity,
                    size: sizeName,
                    desc: optionsDesc.join(', '), // Descripción dinámica
                    imgSrc: card.querySelector('.card-image img').src,
                    // Clave única para agrupar en carrito
                    cartKey: `${card.dataset.name}|${sizeName}|${optionsDesc.join(',')}` 
                };

                const existingProduct = cartList.find(item => item.cartKey === productData.cartKey);
                
                if (existingProduct) {
                    existingProduct.qty += productData.qty;
                } else {
                    cartList.push(productData);
                }
                renderCart();
            }
        });
        
        // Evento para actualizar precio al cambiar listbox o tamaño
        // (Ahora escucha 'change' en toda la sección de productos)
        contenedorProductos.addEventListener('change', (event) => {
            const target = event.target;
            if (target.matches('.modifier-select') || target.matches('.size-btn')) {
                const card = target.closest('.product-card-new');
                if (card) updateCardPrice(card);
            }
        });
    }
    
    // --- (ACTUALIZADO) MANEJADOR DE EVENTOS PARA EL CARRITO ---
    if (cartContent) {
        cartContent.addEventListener('click', e => {
            if (e.target.classList.contains('qty-btn-cart')) {
                const idx = parseInt(e.target.dataset.idx);
                const action = e.target.dataset.action;

                if (action === 'plus') {
                    cartList[idx].qty += 1;
                } else if (action === 'minus') {
                    cartList[idx].qty -= 1;
                    if (cartList[idx].qty <= 0) {
                        cartList.splice(idx, 1);
                    }
                }
                renderCart(); 
            }
        });
    }

    // --- FUNCIONES COMPLETAS DEL CARRITO Y AUXILIARES ---

    // (ACTUALIZADA) renderCart
    function renderCart() { 
        if (!cartContent) return;
        cartContent.innerHTML = '';
        if (cartList.length === 0) {
            cartContent.innerHTML = '<p class="empty-cart" style="text-align:center; font-size:12px; color:var(--muted);">El carrito está vacío</p>';
        } else {
            cartList.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                
                // Usa la descripción dinámica
                let optionsDesc = `${item.size}, ${item.desc}`;

                div.innerHTML = `
                    <div class="cart-thumb"><img src="${item.imgSrc}" alt="${item.name}"></div>
                    <div class="cart-info">
                        <div class="cart-title">${item.name}</div>
                        <div class="cart-desc">${optionsDesc}</div>
                        <div class="cart-price">$${(item.price * item.qty).toFixed(2)}</div> 
                    </div>
                    <div class="cart-qty">
                        <button class="qty-btn-cart" data-idx="${idx}" data-action="minus">-</button>
                        <div class="qty-num">${item.qty.toString().padStart(2, '0')}</div>
                        <button class="qty-btn-cart" data-idx="${idx}" data-action="plus">+</button>
                    </div>`;
                cartContent.appendChild(div);
            });
        }
        updateSummary();
    }

    function updateSummary() { 
        const subtotal = cartList.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const iva = subtotal * IVA_RATE;
        const total = subtotal + iva;
        if (summarySubtotal) summarySubtotal.textContent = `$${subtotal.toFixed(2)}`;
        if (summaryIVA) summaryIVA.textContent = `$${iva.toFixed(2)}`;
        if (summaryTotal) summaryTotal.textContent = `$${(total).toFixed(2)}`;
    }

    // (ACTUALIZADA) updateCardPrice
    function updateCardPrice(card) {
        const basePrice = parseFloat(card.dataset.basePrice);
        
        // Suma de precios de modificadores
        let modifiersPrice = 0;
        const modifiers = card.querySelectorAll('.modifier-select:not(:disabled)');
        modifiers.forEach(select => {
            if(select.selectedIndex > 0) {
                modifiersPrice += parseFloat(select.options[select.selectedIndex].dataset.precioExtra);
            }
        });

        // Precio de tamaño
        const sizeButton = card.querySelector('.size-btn.active');
        const sizeIncrease = sizeButton ? parseFloat(sizeButton.dataset.precioAumento) : 0;
        
        // Cantidad
        const quantity = parseInt(card.querySelector('.quantity-value').textContent);
        
        // Cálculo final
        const unitPrice = basePrice + sizeIncrease + modifiersPrice;
        const finalPrice = unitPrice * quantity;
        
        card.querySelector('.card-price').textContent = `$${finalPrice.toFixed(2)}`;
    }

    // (ELIMINADA) La vieja función generarOpcionesHtml
    // function generarOpcionesHtml(opciones, placeholder) { ... }

    // (SIN CAMBIOS) generarTamanosHtml
    function generarTamanosHtml(tamanos, tamanoDefecto, isFood = false) {
        const tamanoMap = {
            'Chico': {svg: '<svg viewBox="0 0 24 24"><path d="M4 10h16v10a2 2 0 01-2 2H6a2 2 0 01-2-2v-10zm2-4h12v2H6V6z"/></svg>'},
            'Mediano': {svg: '<svg viewBox="0 0 24 24"><path d="M3 8h18v10a3 3 0 01-3 3H6a3 3 0 01-3-3V8zm3-4h12v2H6V4z"/></svg>'},
            'Grande': {svg: '<svg viewBox="0 0 24 24"><path d="M2 7h20v10a4 4 0 01-4 4H6a4 4 0 01-4-4V7zm4-4h12v2H6V3z"/></svg>'}
        };
        const labels = isFood
            ? {'Chico': 'CH', 'Mediano': 'M', 'Grande': 'G'}
            : {'Chico': '250ML', 'Mediano': '500ML', 'Grande': '1L'};

        let html = '';
        if (tamanos) {
            tamanos.forEach(tamano => {
                const displayInfo = tamanoMap[tamano.nombre_tamano] || { svg: '' };
                const texto = labels[tamano.nombre_tamano] || tamano.nombre_tamano;
                const esActivo = tamano.tamano_id == tamanoDefecto ? 'active' : '';
                
                html += `<button class="size-btn ${esActivo}" data-tamano-id="${tamano.tamano_id}" data-precio-aumento="${tamano.precio_aumento}">
                            ${displayInfo.svg}
                            <span>${texto}</span>
                        </button>`;
            });
        }
        return html;
    }

    // Llamada inicial para mostrar el carrito vacío
    renderCart();
});
</script>
</body>
</html>