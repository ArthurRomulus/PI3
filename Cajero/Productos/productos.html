<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>BlackWood Coffe</title>
  <link rel="stylesheet" href="productos.css">
</head>
<body>
<div class="container">
  
  <div id="navbar-placeholder"></div>

  <main class="main">
    <div class="main-scroll">
      <header class="header">
        <h1>BlackWood Coffe</h1>
        <div class="date"> <!--aqui muestra la fecha --></div>
      </header>
      <section class="filters">
        <input class="search" type="search" placeholder="Buscar..." />
        <div class="cats">
          <button class="cat-btn active">Todos</button>
          <button class="cat-btn">Frappes</button>
          <button class="cat-btn">Tés</button>
            <button class="cat-btn">Cafés</button>
          <button class="cat-btn">Comida</button>
          <button class="cat-btn">Postres</button>
          <button class="cat-btn">Panes</button>
        </div>
      </section>
      
      <section class="products" aria-label="Productos">
        </section>
    </div>
  </main>

  <aside class="cart">
    <div class="order-pill"><div class="order-title">Número de Pedido</div><div class="order-number">901</div></div>
    <div class="cart-content"></div>
    <div class="cart-bottom">
      <div class="summary">
        <div class="row"><span>Sub Total:</span> <span class="summary-subtotal">$0.00</span></div>
        <div class="row"><span>IVA:</span> <span class="summary-iva">$0.00</span></div>
        <div class="row total"><span>Total:</span> <span class="summary-total">$0.00</span></div>
      </div>
      <button class="pay">PAGAR</button>
    </div>
  </aside>
</div>

<script src="../barraNav.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Carga de la barra de navegación
    const currentPage = window.location.pathname.split("/").pop();
    if (typeof cargarBarraNav === 'function') {
        cargarBarraNav(currentPage);
    }

    // --- ACTUALIZAR LA FECHA EN TIEMPO REAL ---
    const dateElement = document.querySelector('.date');
    if (dateElement) {
        // Arrays para los nombres en español
        const dias = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
        const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
        
        const fechaActual = new Date();
        
        // Formateamos la fecha al estilo "Jueves, 5 de octubre de 2025"
        const diaSemana = dias[fechaActual.getDay()];
        const diaMes = fechaActual.getDate();
        const mes = meses[fechaActual.getMonth()];
        const anio = fechaActual.getFullYear();
        
        dateElement.textContent = `${diaSemana}, ${diaMes} de ${mes} de ${anio}`;
    }

    // --- VARIABLES Y FUNCIONES DEL CARRITO ---
    const cartList = [];
    const cartContent = document.querySelector('.cart-content');
    const summarySubtotal = document.querySelector('.summary-subtotal');
    const summaryIVA = document.querySelector('.summary-iva');
    const summaryTotal = document.querySelector('.summary-total');
    const IVA_RATE = 0.16;

    // --- LÓGICA DE PRODUCTOS ---
    const contenedorProductos = document.querySelector('.products');
    const filterContainer = document.querySelector('.cats');
    let allProducts = [];

    // --- Función para mostrar productos en la página ---
    function renderProducts(productsToRender, allData) {
        if (!contenedorProductos) return;
        contenedorProductos.innerHTML = '';
        
        productsToRender.forEach(producto => {
            const { modificadores, tamanos } = allData;
            const esCaliente = producto.categoria === 'Bebidas calientes';
            const tagClass = esCaliente ? 'tag-caliente' : 'tag-frio';
            const tagTexto = esCaliente ? 'CALIENTE' : 'FRÍO';
            const opcionesLecheHtml = generarOpcionesHtml(modificadores.leches, 'Tipo Leche');
            const opcionesCafeHtml = generarOpcionesHtml(modificadores.basesCafe, 'Tipo Café');
            const tamanosHtml = generarTamanosHtml(tamanos, producto.tamano_defecto);
            
            const tarjetaHTML = `
                <article class="product-card-new" data-id="${producto.idp}" data-base-price="${producto.precio}" data-name="${producto.namep}">
                    <div class="card-top">
                        <span class="card-tag ${tagClass}">${tagTexto}</span>
                        <span class="card-price">$${parseFloat(producto.precio).toFixed(2)}</span>
                    </div>
                    <div class="card-image"><img src="${producto.ruta_imagen}" alt="${producto.namep}"></div>
                    <div class="card-badge">${producto.namep}</div>
                    <div class="card-options">
                        <div class="option-select"><select class="milk-type">${opcionesLecheHtml}</select></div>
                        <div class="option-select"><select class="coffee-type">${opcionesCafeHtml}</select></div>
                        <div class="option-row quantity-selector">
                            <button class="quantity-btn minus">-</button><span class="quantity-value">1</span><button class="quantity-btn plus">+</button>
                        </div>
                        <div class="option-row size-selector">${tamanosHtml}</div>
                    </div>
                    <textarea class="extra-requests-input" placeholder="Peticiones extras..."></textarea>
                    <button class="add-to-cart-btn">Añadir a Carrito</button>
                </article>`;
            contenedorProductos.insertAdjacentHTML('beforeend', tarjetaHTML);
        });
    }

    // --- CARGA INICIAL DE PRODUCTOS DESDE API ---
    if (contenedorProductos) {
        fetch('api.php')
            .then(response => response.json())
            .then(data => {
                if (data.error) { console.error('Error desde API:', data.error); return; }
                
                allProducts = data.productos;
                renderProducts(allProducts, data);

                if (filterContainer) {
                    filterContainer.addEventListener('click', (event) => {
                        const target = event.target;
                        if (!target.matches('.cat-btn')) return;

                        filterContainer.querySelector('.active').classList.remove('active');
                        target.classList.add('active');

                        const filterType = target.textContent.toLowerCase();
                        let filteredProducts = [];

                        if (filterType === 'todos') {
                            filteredProducts = allProducts;
                        } else if (filterType === 'frappes') {
                            filteredProducts = allProducts.filter(p => p.namep.toLowerCase().includes('frappé'));
                        } else if (filterType === 'tés') {
                            filteredProducts = allProducts.filter(p => p.namep.toLowerCase().includes('té') || p.namep.toLowerCase().includes('tea'));
                        }
                        
                        renderProducts(filteredProducts, data);
                    });
                }
            });
    }

    // --- MANEJADORES DE EVENTOS PARA LAS TARJETAS ---
    if (contenedorProductos) {
        contenedorProductos.addEventListener('click', (event) => {
            const target = event.target;
            const card = target.closest('.product-card-new');
            if (!card) return;

            if (target.matches('.quantity-btn')) {
                const quantitySpan = card.querySelector('.quantity-value');
                let quantity = parseInt(quantitySpan.textContent);
                if (target.matches('.plus')) quantity++;
                else if (target.matches('.minus') && quantity > 1) quantity--;
                quantitySpan.textContent = quantity;
                updateCardPrice(card);
            }

            if (target.closest('.size-btn')) {
                const sizeButton = target.closest('.size-btn');
                card.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
                sizeButton.classList.add('active');
                updateCardPrice(card);
            }

            if (target.matches('.add-to-cart-btn')) {
                const milkSelect = card.querySelector('.milk-type');
                const coffeeSelect = card.querySelector('.coffee-type');
                if (milkSelect.selectedIndex === 0 || coffeeSelect.selectedIndex === 0) {
                    alert('Por favor, selecciona tipo de leche y café.');
                    return;
                }
                const activeSizeButton = card.querySelector('.size-btn.active');
                const unitPrice = parseFloat(card.querySelector('.card-price').textContent.replace('$', '')) / parseInt(card.querySelector('.quantity-value').textContent);
                const productData = {
                    name: card.dataset.name, price: unitPrice, qty: parseInt(card.querySelector('.quantity-value').textContent),
                    size: activeSizeButton ? activeSizeButton.querySelector('span').textContent : 'N/A',
                    milk: milkSelect.options[milkSelect.selectedIndex].text, coffee: coffeeSelect.options[coffeeSelect.selectedIndex].text,
                    requests: card.querySelector('.extra-requests-input').value.trim(), imgSrc: card.querySelector('.card-image img').src
                };
                const existingProduct = cartList.find(item => item.name === productData.name && item.size === productData.size && item.milk === productData.milk && item.coffee === productData.coffee && item.requests === productData.requests);
                if (existingProduct) {
                    existingProduct.qty += productData.qty;
                } else {
                    cartList.push(productData);
                }
                renderCart();
            }
        });
        
        contenedorProductos.addEventListener('change', (event) => {
            const target = event.target;
            if (target.matches('.milk-type') || target.matches('.coffee-type')) {
                const card = target.closest('.product-card-new');
                if (card) updateCardPrice(card);
            }
        });
    }
    
    // --- MANEJADOR DE EVENTOS PARA EL CARRITO ---
    if (cartContent) {
        cartContent.addEventListener('click', e => {
            if (e.target.classList.contains('qty-btn-cart')) {
                const idx = parseInt(e.target.dataset.idx);
                const action = e.target.dataset.action;

                if (action === 'plus') {
                    cartList[idx].qty += 1;
                } else if (action === 'minus') {
                    cartList[idx].qty -= 1;
                    if (cartList[idx].qty <= 0) {
                        // Si la cantidad es 0 o menos, elimina el producto del carrito
                        cartList.splice(idx, 1);
                    }
                }
                renderCart(); // Vuelve a dibujar el carrito con los datos actualizados
            }
        });
    }

    // --- FUNCIONES COMPLETAS DEL CARRITO Y AUXILIARES ---

    function renderCart() {
        if (!cartContent) return;
        cartContent.innerHTML = '';
        if (cartList.length === 0) {
            cartContent.innerHTML = '<p class="empty-cart" style="text-align:center; font-size:12px; color:var(--muted);">El carrito está vacío</p>';
        } else {
            cartList.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                let optionsDesc = `${item.milk}, ${item.coffee}, ${item.size}`;
                if (item.requests) {
                    optionsDesc += ` (${item.requests})`;
                }
                div.innerHTML = `
                    <div class="cart-thumb"><img src="${item.imgSrc}" alt="${item.name}"></div>
                    <div class="cart-info">
                        <div class="cart-title">${item.name}</div>
                        <div class="cart-desc">${optionsDesc}</div>
                        <div class="cart-price">$${(item.price * item.qty).toFixed(2)}</div> 
                    </div>
                    <div class="cart-qty">
                        <button class="qty-btn-cart" data-idx="${idx}" data-action="minus">-</button>
                        <div class="qty-num">${item.qty.toString().padStart(2, '0')}</div>
                        <button class="qty-btn-cart" data-idx="${idx}" data-action="plus">+</button>
                    </div>`;
                cartContent.appendChild(div);
            });
        }
        updateSummary();
    }

    function updateSummary() {
        const subtotal = cartList.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const iva = subtotal * IVA_RATE;
        const total = subtotal + iva;
        if (summarySubtotal) summarySubtotal.textContent = `$${subtotal.toFixed(2)}`;
        if (summaryIVA) summaryIVA.textContent = `$${iva.toFixed(2)}`;
        if (summaryTotal) summaryTotal.textContent = `$${(total).toFixed(2)}`;
    }

    function updateCardPrice(card) {
        const basePrice = parseFloat(card.dataset.basePrice);
        const sizeButton = card.querySelector('.size-btn.active');
        const milkSelect = card.querySelector('.milk-type');
        const coffeeSelect = card.querySelector('.coffee-type');
        const sizeIncrease = sizeButton ? parseFloat(sizeButton.dataset.precioAumento) : 0;
        const milkExtra = milkSelect.selectedIndex > 0 ? parseFloat(milkSelect.options[milkSelect.selectedIndex].dataset.precioExtra) : 0;
        const coffeeExtra = coffeeSelect.selectedIndex > 0 ? parseFloat(coffeeSelect.options[coffeeSelect.selectedIndex].dataset.precioExtra) : 0;
        const quantity = parseInt(card.querySelector('.quantity-value').textContent);
        const unitPrice = basePrice + sizeIncrease + milkExtra + coffeeExtra;
        const finalPrice = unitPrice * quantity;
        card.querySelector('.card-price').textContent = `$${finalPrice.toFixed(2)}`;
    }

    function generarOpcionesHtml(opciones, placeholder) {
        let html = `<option selected disabled>${placeholder}</option>`;
        if (opciones) {
            opciones.forEach(opcion => {
                html += `<option value="${opcion.id_sabor}" data-precio-extra="${opcion.precio_extra}">${opcion.nombre_sabor} ${opcion.precio_extra > 0 ? `(+$${parseFloat(opcion.precio_extra).toFixed(2)})` : ''}</option>`;
            });
        }
        return html;
    }

    function generarTamanosHtml(tamanos, tamanoDefecto) {
        const tamanoMap = {'Chico': {texto: '250ML',svg: '<svg viewBox="0 0 24 24"><path d="M4 10h16v10a2 2 0 01-2 2H6a2 2 0 01-2-2v-10zm2-4h12v2H6V6z"/></svg>'},'Mediano': {texto: '500ML',svg: '<svg viewBox="0 0 24 24"><path d="M3 8h18v10a3 3 0 01-3 3H6a3 3 0 01-3-3V8zm3-4h12v2H6V4z"/></svg>'},'Grande': {texto: '1L',svg: '<svg viewBox="0 0 24 24"><path d="M2 7h20v10a4 4 0 01-4 4H6a4 4 0 01-4-4V7zm4-4h12v2H6V3z"/></svg>'}};
        let html = '';
        if (tamanos) {
            tamanos.forEach(tamano => {
                const displayInfo = tamanoMap[tamano.nombre_tamano] || { texto: tamano.nombre_tamano, svg: '' };
                const esActivo = tamano.tamano_id == tamanoDefecto ? 'active' : '';
                html += `<button class="size-btn ${esActivo}" data-tamano-id="${tamano.tamano_id}" data-precio-aumento="${tamano.precio_aumento}">${displayInfo.svg}<span>${displayInfo.texto}</span></button>`;
            });
        }
        return html;
    }

    // Llamada inicial para mostrar el carrito vacío
    renderCart();
});
</script>
</body>
</html>